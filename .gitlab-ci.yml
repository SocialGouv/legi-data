---
stages:
  - "Code Quality"
  - "Data update"

.node_stage: &node_stage
  image: node:14-alpine
  cache:
    key: ${CI_COMMIT_REF_SLUG}
    paths:
      - node_modules/
  before_script:
    - yarn --frozen-lockfile --prefer-offline

Quality tests:
  <<: *node_stage
  stage: "Code Quality"
  script:
    - yarn test

Data fetch:
  <<: *node_stage
  only:
    - alpha
    - beta
    - master
    - next
  stage: "Data update"
  variables:
    GIT_AUTHOR_EMAIL: 45039513+SocialGroovyBot@users.noreply.github.com
    GIT_AUTHOR_NAME: Social Groovy Bot
    GIT_COMMITTER_EMAIL: $GIT_AUTHOR_EMAIL
    GIT_COMMITTER_NAME: $GIT_AUTHOR_NAME
  before_script:
    - yarn --frozen-lockfile --prefer-offline
    - apk update && apk add git
    - git remote set-url origin https://${GITHUB_TOKEN}@github.com/${CI_PROJECT_PATH}.git
    - echo "//registry.npmjs.org/:_authToken=$NPM_TOKEN" > ~/.npmrc
  script:
    - echo -e "\n" >> ./data/index.json
    - |
      if [[ -n "$(git status -s ./data)" ]]; then
        echo "Files changed, checking JSON validity"
        # Check JSON files
        for filename in ./data/LEGITEXT*\.json; do
          node -e "assert(require('$filename').children.length > 0)" || {
            echo "Invalid JSON in $filename : should have children"
            exit 1
          }
        done

        echo "Commit files"
        # Commit files
        NOW=$(date +"%Y%m%d_%H%M")
        git add data
        git commit -m "feat(data): $NOW update"
        git push --no-verify origin HEAD:${CI_COMMIT_REF_NAME}

        yarn global add semantic-release @semantic-release/git @semantic-release/exec
        $(yarn global bin)/semantic-release

      else
        echo "Nothing changed"
      fi
